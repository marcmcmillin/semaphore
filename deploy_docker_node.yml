# PLAY 1: Infrastructure Provisioning
- name: Stage 1 - Clone and Configure VM
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Ensure proxmoxer is installed
      ansible.builtin.pip:
        name: proxmoxer
        state: present

    - name: Clone Template to New VM
      community.proxmox.proxmox_kvm:
        api_user: "root@pam"
        api_password: "{{ proxmox_password }}"
        api_host: "192.168.42.141"
        node: "rent"
        clone: "noble-cloud-template"
        newid: "{{ user_vm_id }}"
        name: "{{ user_vm_name }}"
        full: yes
        timeout: 1200
        state: present

    - name: Configure Cloud-Init for AWX user
      community.proxmox.proxmox_kvm:
        api_user: "root@pam"
        api_password: "{{ proxmox_password }}"
        api_host: "192.168.42.141"
        node: rent
        vmid: "{{ user_vm_id }}"
        update: yes
        ciuser: "awx"
        sshkeys: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID7mSEzQ3wuj8ktsUQuqVpchDvou5TFxqOAVfstHY9n0 awx@k3s"
        ipconfig:
          ipconfig0: "ip=dhcp"

    - name: Start the newly created VM
      community.proxmox.proxmox_kvm:
        api_user: "root@pam"
        api_password: "{{ proxmox_password }}"
        api_host: "192.168.42.141"
        vmid: "{{ user_vm_id }}"
        state: started

    - name: Wait for Guest Agent to report IPv4
      ansible.builtin.shell: |
        qm guest cmd {{ user_vm_id }} network-get-interfaces | grep -oE '192\.168\.[0-9]+\.[0-9]+' | head -n 1
      register: vm_ipv4
      delegate_to: 192.168.42.147
      remote_user: root
      until: vm_ipv4.stdout != ""
      retries: 30
      delay: 10

    - name: Add New VM to Inventory
      ansible.builtin.add_host:
        name: "{{ vm_ipv4.stdout }}"
        groups: "provisioned_nodes"
        ansible_user: "awx"
        ansible_ssh_extra_args: "-o StrictHostKeyChecking=no"

# PLAY 2: Software Provisioning (THIS STARTS THE NEW PLAY ON THE VM)
- name: Stage 2 - Install Docker
  hosts: provisioned_nodes
  become: true
  gather_facts: true  # Now we can gather facts since the user exists
  tasks:
    - name: Wait for any background apt processes to finish
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/lib/dpkg/lock >/dev/null 2>&1; do 
          sleep 5
        done
      timeout: 300

    - name: Install Docker Dependencies
      ansible.builtin.apt:
        name: [ca-certificates, curl, gnupg]
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker Engine
      ansible.builtin.apt:
        name: [docker-ce, docker-ce-cli, containerd.io, docker-compose-plugin]
        state: present
        update_cache: yes
      register: docker_install
      until: docker_install is success
      retries: 5
      delay: 10

    - name: Ensure Docker service is enabled
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes
