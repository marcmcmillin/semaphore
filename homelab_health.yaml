---
- name: Verify Factory Node Health
  hosts: all
  become: true
  vars:
    # We define the format string here so Ansible doesn't try to parse it as a command
    docker_format: "{{ '{' }}{{ '{' }}.Names{{ '}' }}{{ '}' }}: {{ '{' }}{{ '{' }}.Status{{ '}' }}{{ '}' }}"

  tasks:
    - name: Check Container Status
      ansible.builtin.shell: "docker ps --format '{{ docker_format }}'"
      register: docker_verify
      changed_when: false

    - name: Report Agent Health
      ansible.builtin.debug:
        msg: 
          - "Host: {{ inventory_hostname }}"
          - "Active Agents:"
          - "{{ docker_verify.stdout_lines }}"

    - name: Ensure Port 7007 (Dozzle) is listening
      ansible.builtin.wait_for:
        port: 7007
        state: started
        timeout: 5
